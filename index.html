<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Left</title>
    <link rel="stylesheet" href="common.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@700&family=Ma+Shan+Zheng&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript/lunar.js"></script>
</head>
<body>
    <!-- åŠ¨æ€èƒŒæ™¯ -->
    <div class="background-shapes">
        <div class="heart-pink"></div>
        <div class="heart-blue"></div>
    </div>

    <div class="main-container">
        <!-- è®¡æ—¶å™¨æ¿å— -->
        <section class="timer-section">
            <div class="time-display">
                <div id="current-time" class="current-time"></div>
                <div id="lunar-info" class="lunar-info"></div>
            </div>
            
            <div class="love-timer">
                <div class="timer-label">åœ¨ä¸€èµ·å·²ç»</div>
                <div id="love-timer"></div>
            </div>
        </section>

        <!-- åŠŸèƒ½æ¿å— -->
        <section class="features-section">
            <div class="feature-card" data-feature="love">
                <div class="icon">ğŸ’Œ</div>
                <h3>æƒ…è¯æ—¶å…‰</h3>
                <p>æ¸©é¦¨æµªæ¼«çš„æƒ…è¯åˆ†äº«</p>
            </div>
            
            <div class="feature-card" data-feature="parenting">
                <div class="icon">ğŸ‘¶</div>
                <h3>è‚²å„¿çŸ¥è¯†</h3>
                <p>ä¸“ä¸šçš„è‚²å„¿å»ºè®®</p>
            </div>
            
            <div class="feature-card" data-feature="fun">
                <div class="icon">ğŸ®</div>
                <h3>è¶£å‘³ç©ºé—´</h3>
                <p>æœ‰è¶£çš„äº’åŠ¨å†…å®¹</p>
            </div>
            
            <div class="feature-card" data-feature="fortune">
                <div class="icon">ğŸŒŸ</div>
                <h3>ä»Šæ—¥è¿åŠ¿</h3>
                <p>æ˜Ÿåº§è¿åŠ¿æŸ¥è¯¢</p>
            </div>
            
            <div class="feature-card" data-feature="about">
                <div class="icon">â„¹ï¸</div>
                <h3>å…³äºé¡¹ç›®</h3>
                <p>é¡¹ç›®ä»‹ç»ä¸è¯´æ˜</p>
            </div>
        </section>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // åˆå§‹åŒ–åŠŸèƒ½å¡ç‰‡
            function initFeatureCards() {
                const featureCards = document.querySelectorAll('.feature-card');
                if (!featureCards || featureCards.length === 0) return;

                featureCards.forEach((card, index) => {
                    if (!card) return;
                    
                    card.style.setProperty('--i', index);
                    card.addEventListener('click', (e) => {
                        e.preventDefault();
                        const feature = card.dataset.feature;
                        if (!feature) return;
                        
                        // æ·»åŠ ç‚¹å‡»åé¦ˆ
                        card.style.transform = 'scale(0.98)';
                        setTimeout(() => {
                            card.style.transform = '';
                            
                            switch(feature) {
                                case 'love':
                                    window.location.href = 'love.html';
                                    break;
                                case 'parenting':
                                    window.location.href = 'parenting.html';
                                    break;
                                case 'fun':
                                    window.location.href = 'joke.html';
                                    break;
                                case 'fortune':
                                    showFortuneIsland();
                                    break;
                                case 'about':
                                    window.location.href = 'about.html';
                                    break;
                            }
                        }, 150);
                    });
                });
            }

            // åˆå§‹åŒ–è®¡æ—¶å™¨
            function initializeTimers() {
                function updateTime() {
                    const timeElement = document.getElementById('current-time');
                    const lunarElement = document.getElementById('lunar-info');
                    
                    if (!timeElement || !lunarElement) return;
                    
                    const now = new Date();
                    timeElement.textContent = now.toLocaleTimeString('zh-CN');
                    
                    const lunar = Lunar.fromDate(now);
                    lunarElement.innerHTML = `
                        ${lunar.getYearInGanZhi()}å¹´ ${lunar.getMonthInChinese()}æœˆ${lunar.getDayInChinese()} 
                    `;
                }

                function updateLoveTimer() {
                    const loveTimerElement = document.getElementById('love-timer');
                    if (!loveTimerElement) return;
                    
                    const startDate = new Date('2022-08-19');
                    const now = new Date();
                    const diff = now - startDate;
                    
                    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                    
                    loveTimerElement.textContent = `${days}å¤© ${hours}æ—¶ ${minutes}åˆ† ${seconds}ç§’`;
                }

                updateTime();
                updateLoveTimer();
                setInterval(updateTime, 1000);
                setInterval(updateLoveTimer, 1000);
            }

            // åˆå§‹åŒ–æ‰€æœ‰åŠŸèƒ½
            try {
                initFeatureCards();
                initializeTimers();
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
            }

            // æ˜¾ç¤ºæ¬¢è¿ä¿¡æ¯
            setTimeout(() => {
                showDynamicIsland('æ¬¢è¿å›æ¥ï¼ä»Šå¤©ä¹Ÿè¦å¼€å¿ƒå“¦ ğŸ’–');
            }, 1000);

            // æ˜¾ç¤ºçµåŠ¨å²›
            setTimeout(() => {
                initDynamicIsland();
            }, 1000);

            // æ·»åŠ é¼ æ ‡è·Ÿè¸ªå‘å…‰æ•ˆæœ
            const cards = document.querySelectorAll('.feature-card');
            const container = document.querySelector('.features-section');

            // æ›´æ–°é¼ æ ‡ä½ç½®å˜é‡
            function handleMouseMove(e) {
                const cards = document.querySelectorAll('.feature-card');
                cards.forEach(card => {
                    const rect = card.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    
                    card.style.setProperty('--mouse-x', `${x}px`);
                    card.style.setProperty('--mouse-y', `${y}px`);
                });
            }

            // å¤„ç†å¡ç‰‡çš„å‘å…‰æ•ˆæœä¼ æ’­
            function handleCardHover(e) {
                const hoveredCard = e.currentTarget;
                const cards = document.querySelectorAll('.feature-card');
                const index = Array.from(cards).indexOf(hoveredCard);
                
                cards.forEach((card, i) => {
                    const distance = Math.abs(i - index);
                    const delay = distance * 100;
                    const opacity = Math.max(0, 1 - distance * 0.3);
                    
                    card.style.transition = `all 0.3s ease ${delay}ms`;
                    if (distance <= 2) { // åªå½±å“ç›¸é‚»çš„ä¸¤å¼ å¡ç‰‡
                        card.style.setProperty('--glow-opacity', opacity.toString());
                        card.classList.add('neighbor-glow');
                    }
                });
            }

            // ç§»é™¤å‘å…‰æ•ˆæœ
            function handleCardLeave() {
                const cards = document.querySelectorAll('.feature-card');
                cards.forEach(card => {
                    card.style.transition = 'all 0.3s ease';
                    card.style.setProperty('--glow-opacity', '0');
                    card.classList.remove('neighbor-glow');
                });
            }

            // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            if (container) {
                container.addEventListener('mousemove', handleMouseMove);
                cards.forEach(card => {
                    card.addEventListener('mouseenter', handleCardHover);
                    card.addEventListener('mouseleave', handleCardLeave);
                });
            }

            // æ·»åŠ æ»šåŠ¨æ£€æµ‹
            const featuresSection = document.querySelector('.features-section');
            if (featuresSection && window.innerWidth <= 768) {
                let scrollTimeout;
                let isScrolling = false;
                const cards = document.querySelectorAll('.feature-card');

                // æ£€æµ‹å…ƒç´ æ˜¯å¦åœ¨è§†å£ä¸­
                const isInViewport = (el) => {
                    const rect = el.getBoundingClientRect();
                    return (
                        rect.top >= 0 &&
                        rect.left >= 0 &&
                        rect.bottom <= window.innerHeight &&
                        rect.right <= window.innerWidth
                    );
                };

                // æ›´æ–°å¡ç‰‡çŠ¶æ€
                const updateCards = () => {
                    cards.forEach(card => {
                        if (isInViewport(card)) {
                            card.classList.add('in-view');
                        } else {
                            card.classList.remove('in-view');
                        }
                    });
                };

                // æ»šåŠ¨å¤„ç†
                featuresSection.addEventListener('scroll', () => {
                    if (!isScrolling) {
                        isScrolling = true;
                        cards.forEach(card => card.classList.add('scrolling'));
                    }

                    clearTimeout(scrollTimeout);
                    scrollTimeout = setTimeout(() => {
                        isScrolling = false;
                        cards.forEach(card => card.classList.remove('scrolling'));
                        updateCards();
                    }, 150);
                }, { passive: true });

                // åˆå§‹åŒ–å¡ç‰‡çŠ¶æ€
                updateCards();

                // æ·»åŠ è§¦æ‘¸äº‹ä»¶ä¼˜åŒ–
                let touchStartY;
                featuresSection.addEventListener('touchstart', (e) => {
                    touchStartY = e.touches[0].clientY;
                }, { passive: true });

                featuresSection.addEventListener('touchmove', (e) => {
                    if (!touchStartY) return;
                    const touchY = e.touches[0].clientY;
                    const diff = touchStartY - touchY;
                    
                    if (Math.abs(diff) > 5) {
                        cards.forEach(card => card.classList.add('scrolling'));
                    }
                }, { passive: true });

                featuresSection.addEventListener('touchend', () => {
                    touchStartY = null;
                    setTimeout(() => {
                        cards.forEach(card => card.classList.remove('scrolling'));
                        updateCards();
                    }, 150);
                }, { passive: true });
            }
        });

        // çµåŠ¨å²›æ•°æ®æ˜¾ç¤º
        async function showDynamicIsland() {
            try {
                // è·å–APIæ•°æ®
                const response = await fetch('https://api.kuleu.com/api/getGreetingMessage?type=json');
                const result = await response.json();
                
                if (result.code === 200) {
                    const data = result.data;
                    
                    // ç§»é™¤å·²å­˜åœ¨çš„çµåŠ¨å²›
                    document.querySelectorAll('.dynamic-island, .dynamic-island-overlay').forEach(el => el.remove());

                    // åˆ›å»ºæ–°çš„çµåŠ¨å²›
                    const island = document.createElement('div');
                    island.className = 'dynamic-island';
                    
                    const overlay = document.createElement('div');
                    overlay.className = 'dynamic-island-overlay';
                    
                    // æ„å»ºå†…å®¹
                    const content = `
                        <div class="modal-content">
                            <div class="greeting-content">
                                <div class="greeting-time">${data.currentTime}</div>
                                <div class="greeting-message">${data.greeting}</div>
                                ${data.tip ? `<div class="greeting-tip">${data.tip}</div>` : ''}
                            </div>
                        </div>
                    `;
                    
                    island.innerHTML = content;
                    
                    // æ·»åŠ åˆ°é¡µé¢
                    document.body.appendChild(overlay);
                    document.body.appendChild(island);
                    
                    // æ˜¾ç¤ºåŠ¨ç”»
                    requestAnimationFrame(() => {
                        island.classList.add('show');
                    });

                    // ç‚¹å‡»é®ç½©å±‚å…³é—­çµåŠ¨å²›
                    overlay.addEventListener('click', closeDynamicIsland);
                    
                    // è§¦æ‘¸äº‹ä»¶æ”¯æŒ
                    overlay.addEventListener('touchend', (e) => {
                        e.preventDefault();
                        closeDynamicIsland();
                    });

                    // è‡ªåŠ¨å…³é—­
                    setTimeout(() => {
                        closeDynamicIsland();
                    }, 5000); // 5ç§’åè‡ªåŠ¨å…³é—­
                    
                } else {
                    console.error('APIè¿”å›é”™è¯¯:', result.msg);
                }
            } catch (error) {
                console.error('è·å–æ•°æ®å¤±è´¥:', error);
            }
        }

        // æ—¶æ–°çµåŠ¨å²›
        function initDynamicIsland() {
            // é¦–æ¬¡æ˜¾ç¤º
            showDynamicIsland();

            // æ¯éš”ä¸€æ®µæ—¶é—´åˆ·æ–°ä¸€æ¬¡
            setInterval(() => {
                showDynamicIsland();
            }, 30 * 60 * 1000); // æ¯30åˆ†é’Ÿåˆ·æ–°ä¸€æ¬¡
        }

        // å…³çµåŠ¨å²›
        function closeDynamicIsland() {
            const island = document.querySelector('.dynamic-island');
            const overlay = document.querySelector('.dynamic-island-overlay');
            
            if (island && overlay) {
                island.classList.add('fade-out');
                setTimeout(() => {
                    island.remove();
                    overlay.remove();
                }, 600);
            }
        }

        // ä¿®æ”¹è¿åŠ¿çµåŠ¨å²›å‡½æ•°
        async function showFortuneIsland() {
            try {
                // ä½¿ç”¨ JSONP å¤„ç†è·¨åŸŸ
                const jsonpCallback = 'fortuneCallback_' + Date.now();
                window[jsonpCallback] = function(data) {
                    handleFortuneData(data);
                    delete window[jsonpCallback];
                };

                const script = document.createElement('script');
                script.src = `http://web.juhe.cn:8080/constellation/getAll?consName=å·¨èŸ¹åº§&type=today&key=4a11bbcbf089edaf14c2d9bdb80c2ec4&callback=${jsonpCallback}`;
                document.body.appendChild(script);
                
                // è¶…æ—¶å¤„ç†
                setTimeout(() => {
                    if (window[jsonpCallback]) {
                        delete window[jsonpCallback];
                        showErrorMessage('è¯·æ±‚è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•');
                    }
                }, 5000);
            } catch (error) {
                console.error('è¿åŠ¿APIè¯·æ±‚å¤±è´¥:', error);
                showErrorMessage('ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }

        // å¤„ç†è¿åŠ¿æ•°æ®
        function handleFortuneData(data) {
            if (data.error_code === 0) {
                // ç§»é™¤å·²å­˜åœ¨çš„çµåŠ¨å²›
                document.querySelectorAll('.dynamic-island, .dynamic-island-overlay').forEach(el => el.remove());

                // åˆ›å»ºæ–°çš„çµåŠ¨å²›
                const island = document.createElement('div');
                island.className = 'dynamic-island fortune-island';
                
                const overlay = document.createElement('div');
                overlay.className = 'dynamic-island-overlay';
                
                // æ„å»ºè¿åŠ¿å†…å®¹
                const content = `
                    <div class="modal-content">
                        <div class="fortune-content">
                            <div class="fortune-title">
                                <span class="fortune-icon">â™‹</span>
                                <span>å·¨èŸ¹åº§ä»Šæ—¥è¿åŠ¿</span>
                            </div>
                            <div class="fortune-date">${data.datetime || new Date().toLocaleDateString()}</div>
                            <div class="fortune-summary">${data.summary || 'ä»Šæ—¥è¿åŠ¿åŠ è½½ä¸­...'}</div>
                            <div class="fortune-details">
                                <div class="fortune-item">
                                    <span class="item-label">å¹¸è¿è‰²</span>
                                    <span class="item-value">${data.color || '-'}</span>
                                </div>
                                <div class="fortune-item">
                                    <span class="item-label">å¹¸è¿æ•°å­—</span>
                                    <span class="item-value">${data.number || '-'}</span>
                                </div>
                                <div class="fortune-item">
                                    <span class="item-label">é€Ÿé…æ˜Ÿåº§</span>
                                    <span class="item-value">${data.QFriend || '-'}</span>
                                </div>
                            </div>
                            <div class="fortune-scores">
                                <div class="score-item">
                                    <span class="score-label">ç»¼åˆæŒ‡æ•°</span>
                                    <span class="score-value">${"â­".repeat(Math.round(parseInt(data.all || 0) / 20))}</span>
                                </div>
                                <div class="score-item">
                                    <span class="score-label">çˆ±æƒ…æŒ‡æ•°</span>
                                    <span class="score-value">${"â­".repeat(Math.round(parseInt(data.love || 0) / 20))}</span>
                                </div>
                                <div class="score-item">
                                    <span class="score-label">äº‹ä¸šæŒ‡æ•°</span>
                                    <span class="score-value">${"â­".repeat(Math.round(parseInt(data.work || 0) / 20))}</span>
                                </div>
                                <div class="score-item">
                                    <span class="score-label">è´¢è¿æŒ‡æ•°</span>
                                    <span class="score-value">${"â­".repeat(Math.round(parseInt(data.money || 0) / 20))}</span>
                                </div>
                                <div class="score-item">
                                    <span class="score-label">å¥åº·æŒ‡æ•°</span>
                                    <span class="score-value">${"â­".repeat(Math.round(parseInt(data.health || 0) / 20))}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                island.innerHTML = content;
                
                // æ·»åŠ åˆ°é¡µé¢
                document.body.appendChild(overlay);
                document.body.appendChild(island);
                
                // æ˜¾ç¤ºåŠ¨ç”»
                requestAnimationFrame(() => {
                    island.classList.add('show');
                });
                
            } else {
                console.error('è·å–è¿åŠ¿æ•°æ®å¤±è´¥:', data.reason);
                // æ˜¾ç¤ºé”™è¯¯æç¤º
                showErrorMessage('è¿åŠ¿æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // æ·»åŠ é”™è¯¯æç¤ºå‡½æ•°
        function showErrorMessage(message) {
            const island = document.createElement('div');
            island.className = 'dynamic-island error-island';
            
            const overlay = document.createElement('div');
            overlay.className = 'dynamic-island-overlay';
            
            const content = `
                <div class="modal-content">
                    <div class="error-content">
                        <span class="error-icon">âš ï¸</span>
                        <span class="error-message">${message}</span>
                    </div>
                </div>
            `;
            
            island.innerHTML = content;
            
            document.body.appendChild(overlay);
            document.body.appendChild(island);
            
            requestAnimationFrame(() => {
                island.classList.add('show');
            });
            
            // 3ç§’åè‡ªåŠ¨å…³é—­
            setTimeout(() => {
                closeDynamicIsland();
            }, 3000);
        }

        // åœ¨ body æ ‡ç­¾åæ·»åŠ äº‹ä»¶ç›‘å¬
        document.body.addEventListener('click', (e) => {
            const island = document.querySelector('.dynamic-island');
            const overlay = document.querySelector('.dynamic-island-overlay');
            
            // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯çµåŠ¨å²›å†…å®¹ï¼Œåˆ™å…³é—­çµåŠ¨å²›
            if (island && !island.contains(e.target)) {
                closeDynamicIsland();
            }
        });

        // æ·»åŠ è§¦æ‘¸äº‹ï¿½ï¿½ï¿½æ”¯æŒ
        document.body.addEventListener('touchend', (e) => {
            const island = document.querySelector('.dynamic-island');
            const overlay = document.querySelector('.dynamic-island-overlay');
            
            // å¦‚æœè§¦æ‘¸çš„ä¸æ˜¯çµåŠ¨å²›å†…å®¹ï¼Œåˆ™å…³é—­çµåŠ¨å²›
            if (island && !island.contains(e.target)) {
                e.preventDefault();
                closeDynamicIsland();
            }
        });
    </script>
</body>
</html> 